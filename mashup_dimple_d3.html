<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <script src="/windows/resources/assets/external/requirejs/require.js"></script>
  <link rel="stylesheet" href="/windows/resources/autogenerated/qlik-styles.css">
</head>

<body onLoad="start()">

<table border="1" width="100%" height="100%">
  <tbody>
    <tr>
      <td colspan="3" width="100%" height="10%"><div id="QV01" style="width:100%;height:100%;"></div></td>
    </tr>
    <tr>
      <td width="30%" height="45%"><div id="QV02" style="width:100%;height:100%;"></div></td>
      <td colspan="2" rowspan="2" width="70%" height="80%"><div id="QV04" style="width:100%;height:100%;overflow-y:scroll;"></div></td>
    </tr>
    <tr>
      <td width="30%" height="45%"><div id="QV03" style="width:100%;height:100%;"></div></td>
    </tr>
  </tbody>
</table>

<script>
function start() {

var server = {
  host: 'jptok-tts-r2vm', // Qlik Sense sever name
  port: 443,              // Qlik Sense port
  prefix: '/windows/',    // Virtual Proxy prefix
  isSecure: true          // true=https, false=http
};
require.config({
  baseUrl: (server.isSecure ? "https://" : "http://") + server.host + (server.port ? ":"+server.port : "") + server.prefix + "resources"
});
require(["js/qlik", "jquery"], function(qlik, $) {
  alert("Qlik's D3.js version: " + d3.version);
  qlik.setLanguage('ja-JP');                           // 表示言語
  qlik.theme.apply('breeze');                          // Theme ID
  var app_id = '9de2ab76-e358-4f0c-8a93-f32ea36cd3db'; // App ID
  var app = qlik.openApp(app_id, server);
  app.getObject('QV01', 'CurrentSelections'); // 選択バー
  app.getObject('QV02', 'BDQru');             // フィルターパネル
  app.getObject('QV03', 'CzcvAzC');           // フィルターパネル

  // HyperCubeの生成
  app.createCube({
    "qDimensions": [{
      "qDef": { "qFieldDefs": ["営業員名"], "qFieldLabels": ["営業員名"] },
      "qNullSuppression": true,
      "qOtherTotalSpec": {
        "qOtherMode": "OTHER_OFF",
        "qSuppressOther": true,
        "qOtherSortMode": "OTHER_SORT_DESCENDING",
        "qOtherCounted": { "qv": "5" },
        "qOtherLimitMode": "OTHER_GE_LIMIT"
      }
    }],
    "qMeasures": [{
      "qDef": { "qDef": "Sum([販売価格])", "qLabel": "実績",
                "qNumFormat": {"qType": "M", "qUseThou": 1, "qThou": ","} },
      "qLibraryId": null, // マスターアイテムID
      "qSortBy": {
        "qSortByState": 0,
        "qSortByFrequency": 0,
        "qSortByNumeric": -1, // ソート: 0=無し, 1=昇順, -1=降順
        "qSortByAscii": 0,
        "qSortByLoadOrder": 0,
        "qSortByExpression": 0,
        "qExpression": { "qv": " " }
      }
    }],
    "qSuppressZero": false,
    "qSuppressMissing": false,
    "qMode": "S",
    "qInterColumnSortOrder": [1,0], // ソート順: 1=実績, 0=営業員名
    "qStateName": "$"
  }).then(function(model) {
    // HyperCubeの生成後
    var width = model.layout.qHyperCube.qSize.qcx;
    var height = (width==0) ? 1 : Math.floor(10000 / width);
    model.layout.qHyperCube.qDataPages = [];
    getAllData(width, height, 0);
    function getAllData(w, h, lr) {
      var requestPage = [{qTop: lr, qLeft: 0, qWidth: w, qHeight: h}];
      model.getHyperCubeData('/qHyperCubeDef',requestPage).then(function(dataPages) {
        model.layout.qHyperCube.qDataPages.push(dataPages[0]);
        var n = dataPages[0].qMatrix.length;
        if(lr + n >= model.layout.qHyperCube.qSize.qcy) {
          renderingHyperCube();
          return;
        }
        getAllData(w, h, lr + n);
      });
    }
    // 集計データが再計算されたイベントをキャッチ
    model.Validated.bind(function() {
      model.layout.qHyperCube.qDataPages = [];
      getAllData(width, height, 0);
    });
    // 全セルデータを dimple.js + d3.js(v4.13.0) でBarchart表示
    function renderingHyperCube() {
      var dimple_require = requirejs.config({
        // https://jptok-tts-r2vm:443
        baseUrl: (server.isSecure ? "https://" : "http://") + server.host + (server.port ? ":"+server.port : ""),
        paths: {
          d3: "/windows/content/mashup/d3.min",
          dimple: "/windows/content/mashup/dimple.latest.min"
        }
        // またはCDNからロード
        //paths: {
        //  d3: "https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min",
        //  dimple: "https://cdnjs.cloudflare.com/ajax/libs/dimple/2.3.0/dimple.latest.min"
        //}
      });
      dimple_require(["d3", "dimple"], function(d3, dimple) {
        alert("My D3.js version: " + d3.version);
        alert("dimple.js version: " + dimple.version);
        //console.log(model.layout.qHyperCube);
        var alldata = [];
        var hc = model.layout.qHyperCube, allDataPages = hc.qDataPages;
        var x_axis = hc.qDimensionInfo[0].qFallbackTitle;
        var y_axis = hc.qMeasureInfo[0].qFallbackTitle;
        for(let p of allDataPages) {
          var pdata = p.qMatrix.map(function(d) {
                        var x = d[0].qText;
                        var y = d[1].qNum;
                        if(y=="NaN" || isNaN(y)) y = 0;
                        var item = new Object();
                        item[x_axis] = x;
                        item[y_axis] = y;
                        return item;
                      });
          alldata = alldata.concat(pdata);
        }
        var div = $("#QV04");
        div.children().remove();
        var d_w = div.width(), d_h = div.height();
        var svg = dimple.newSvg("#QV04", d_w, d_h);
        var myChart = new dimple.chart(svg, alldata);
        myChart.setBounds(60,30,d_w-60*2,d_h-30*3);
        myChart.addCategoryAxis("x", x_axis);
        myChart.addMeasureAxis("y", y_axis);
        myChart.addSeries(null, dimple.plot.bar);
        myChart.draw();
      });
    }
  });
});

}
</script>

</body>
</html>
